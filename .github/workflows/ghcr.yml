name: Deploy backend to GHCR

on:
  push:
    branches: ['main']
  workflow_dispatch:

jobs:
      push-backend-image:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: '.'
        steps:
          - uses: actions/checkout@v3
            name: ✅ Checkout
          - uses: docker/setup-qemu-action@v1
            name: 🦾 Setup QEMU
          - uses: docker/setup-buildx-action@v1
            name: 🏗️ Setup Buildx
            with:
              version: "v0.5.1"
              buildkitd-flags: --debug
          - uses: docker/login-action@v1
            name: 🔑 Login to GHCR
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}
          - uses: docker/build-push-action@v2
            name: 🚀 Build and push
            with:
              context: .
              file: ./Dockerfile
              platforms: linux/amd64
              push: true
              tags: |
                ghcr.io/shadowdevfr/naobluesky:latest